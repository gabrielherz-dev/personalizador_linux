#!/usr/bin/env bash
set -euo pipefail

# Instalaci√≥n de Cortile en Debian 12 XFCE4 usando binario precompilado con verificaci√≥n SHA256

# Dependencias necesarias (incluye certificados para HTTPS y verificaci√≥n hash)
apt update
apt install -y wget jq tar ca-certificates coreutils

# Actualizar certificados
update-ca-certificates

# Carpeta de instalaci√≥n
INSTALL_DIR="$HOME/.local/bin"
mkdir -p "$INSTALL_DIR"

# Rutas temporales
TMP_DIR=$(mktemp -d)
TAR_FILE="$TMP_DIR/cortile.tar.gz"
SHA_FILE="$TMP_DIR/cortile.sha256"

# Obtener URL del binario y de la suma SHA256
ASSET_INFO=$(wget -qO- https://api.github.com/repos/leukipp/cortile/releases/latest)
BIN_URL=$(echo "$ASSET_INFO" | jq -r '.assets[] | select(.name | endswith("linux_amd64.tar.gz")) | .browser_download_url')
SHA_URL=$(echo "$ASSET_INFO" | jq -r '.assets[] | select(.name | endswith("linux_amd64.tar.gz.sha256")) | .browser_download_url')

if [[ -z "$BIN_URL" ]]; then
    echo "‚ùå No se encontr√≥ binario para linux_amd64 en la √∫ltima release."
    exit 1
fi

if [[ -z "$SHA_URL" ]]; then
    echo "‚ùå No se encontr√≥ archivo SHA256 en la √∫ltima release."
    exit 1
fi

echo "üì• Descargando binario..."
wget -qO "$TAR_FILE" "$BIN_URL"

echo "üì• Descargando suma SHA256..."
wget -qO "$SHA_FILE" "$SHA_URL"

# Verificar integridad
echo "üîç Verificando integridad..."
cd "$TMP_DIR"
if ! sha256sum --check --status "$SHA_FILE"; then
    echo "‚ùå Verificaci√≥n de hash fallida. Abortando instalaci√≥n."
    exit 1
fi
cd -

echo "‚úÖ Verificaci√≥n correcta."

# Extraer binario
tar -xz -C "$INSTALL_DIR" -f "$TAR_FILE"
chmod +x "$INSTALL_DIR"/cortile*

# Usar nombre est√°ndar
if [[ -f "$INSTALL_DIR/cortile" ]]; then
    BIN="$INSTALL_DIR/cortile"
else
    BIN=$(find "$INSTALL_DIR" -type f -name "cortile*" | head -n1)
    ln -sf "$BIN" "$INSTALL_DIR/cortile"
fi

# A√±adir al PATH si no est√°
if ! grep -q "$INSTALL_DIR" <<< "$PATH"; then
    echo "export PATH=\"$INSTALL_DIR:\$PATH\"" >> "$HOME/.bashrc"
fi

# Crear autostart
AUTOSTART_DIR="$HOME/.config/autostart"
mkdir -p "$AUTOSTART_DIR"

cat > "$AUTOSTART_DIR/cortile.desktop" <<EOF
[Desktop Entry]
Type=Application
Name=Cortile
Exec=$BIN
Comment=Auto-tiling para XFCE4
X-GNOME-Autostart-enabled=true
EOF

echo "üéâ Instalaci√≥n completada."
echo "üìÇ Binario: $BIN"
echo "‚ö° Para ejecutarlo ahora: $BIN &"

# Limpiar temporales
rm -rf "$TMP_DIR"

